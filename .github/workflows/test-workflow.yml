on: workflow_dispatch
name: Test
jobs:
  create-and-update-deployment:
    name: Run local create-deployment
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Create deployment
        id: create-deployment
        uses: ./create-deployment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          task: deploy
          auto-merge: false
          required-contexts: ""
          payload: '{
            "test": "test-payload"
            }'
          environment: test
          description: ""
          production-environment: false
          transient-environment: false

      - name: Create deployment status
        uses: ./create-deployment-status
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.create-deployment.outputs.deployment-id }}
          state: success

  remove-deployment:
    needs: create-and-update-deployment
    name: Run local remove-deployment
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Local Action
        uses: ./remove-deployment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          environment: test

  configure-aws-credentials:
    name: Configure AWS credentials
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Local Action
        uses: ./configure-aws-credentials
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-profile: sp-exp-1

  create-workflow-dispatch:
    name: Run local workflow dispatch
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Local Action
        uses: ./create-workflow-dispatch
        with:
          ref: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          workflow-id: lint-and-package-workflow.yml
          inputs: '{"test": "true"}'
